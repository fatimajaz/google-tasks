<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Google Tasks Embed</title>
  <!-- Include Google Sign-In and API Libraries -->
  <script src="https://apis.google.com/js/platform.js" async defer></script>
  <script src="https://apis.google.com/js/api.js" async defer></script>
  <!-- Add your API key and Client ID -->
  <script>
    const API_KEY = 'AIzaSyCrcMI3IL1SHdDAksbtQVEuTZBIjHhCKOI';
    const CLIENT_ID = '469907870120-iecguv6bovdlicjaqtiq8044hl1mkl3j.apps.googleusercontent.com';
  </script>
</head>
<body>
  <!-- Google Sign-In button -->
  <div class="g-signin2" data-onsuccess="onSignIn"></div>

  <!-- Dropdown for Task Lists -->
  <label for="taskLists">Select Task List:</label>
  <select id="taskLists" onchange="fetchTasks()">
    <!-- Options will be dynamically added here -->
  </select>

  <!-- Task Container -->
  <div id="tasksContainer">
    <!-- Tasks will be displayed here -->
  </div>

  <script>
    let gapiLoaded = false;
    let tokenClient;

    // Callback after API and Sign-In libraries are loaded
    function gapiLoaded() {
      gapi.load('client:auth2', initializeGapiClient);
    }

    // Initialize the API client and Google Sign-In
    async function initializeGapiClient() {
      await gapi.client.init({
        apiKey: API_KEY,
        clientId: CLIENT_ID,
        discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/tasks/v1/rest'],
        scope: 'https://www.googleapis.com/auth/tasks.readonly',
      });

      // Initialize Google Identity Services
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: 'https://www.googleapis.com/auth/tasks.readonly',
        callback: '', // Defined later
      });

      gapiLoaded = true;
      maybeEnableButtons();
    }

    // Enable buttons after all libraries are loaded
    function maybeEnableButtons() {
      if (gapiLoaded) {
        document.querySelector('.g-signin2').style.display = 'block';
      }
    }

    // Sign in the user upon button click
    function onSignIn(googleUser) {
      // Handle sign-in success, and then trigger your own authentication logic
      // You can use googleUser.getAuthResponse().id_token to get the ID token for authentication
      tokenClient.requestAccessToken({ prompt: 'get' })
        .then(() => fetchTaskLists());
    }

    // Fetch and display task lists
    async function fetchTaskLists() {
      const response = await gapi.client.tasks.tasklists.list();
      const taskLists = response.result.items;

      // Populate the dropdown with task lists
      const taskListsDropdown = document.getElementById('taskLists');
      taskListsDropdown.innerHTML = '';
      taskLists.forEach(taskList => {
        const option = document.createElement('option');
        option.value = taskList.id;
        option.text = taskList.title;
        taskListsDropdown.appendChild(option);
      });

      // Fetch tasks for the selected task list
      fetchTasks();
    }

    // Fetch and display tasks for the selected task list
    async function fetchTasks() {
      const selectedTaskListId = document.getElementById('taskLists').value;
      const response = await gapi.client.tasks.tasks.list({
        tasklist: selectedTaskListId,
      });
      const tasks = response.result.items;

      // Display tasks in the tasksContainer
      const tasksContainer = document.getElementById('tasksContainer');
      tasksContainer.innerHTML = '';
      if (tasks && tasks.length > 0) {
        tasks.forEach(task => {
          const taskItem = document.createElement('div');
          taskItem.innerText = task.title;
          tasksContainer.appendChild(taskItem);
        });
      } else {
        tasksContainer.innerText = 'No tasks found.';
      }
    }
  </script>

  <!-- Trigger loading of Google libraries -->
  <script async defer src="https://apis.google.com/js/api.js?onload=gapiLoaded"></script>
</body>
</html>
